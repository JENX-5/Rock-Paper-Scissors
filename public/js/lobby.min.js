class Lobby {
    constructor() {
        this.skin = 0;
        this.init();
    }

    init() {
        this.loadSavedData();
        this.initEventListeners();
        this.applyTheme();
    }

    loadSavedData() {
        this.skin = parseInt(localStorage.getItem('rps_skin') || '0');
        const savedName = localStorage.getItem('rps_name');
        if (savedName) {
            document.getElementById('name').value = savedName;
        }
    }

    initEventListeners() {
        // Skin selection
        document.querySelectorAll('.skin-option').forEach(option => {
            option.addEventListener('click', () => {
                this.skin = parseInt(option.dataset.skin);
                localStorage.setItem('rps_skin', this.skin);
                this.applyTheme();
            });
        });

        // Name input
        document.getElementById('name').addEventListener('input', (e) => {
            localStorage.setItem('rps_name', e.target.value.trim());
        });

        // Buttons
        document.getElementById('playCpu').addEventListener('click', () => this.startCPU());
        document.getElementById('createRoom').addEventListener('click', () => this.createRoom());
        document.getElementById('joinRoom').addEventListener('click', () => this.joinRoom());
    }

    applyTheme() {
        document.body.className = `theme-${this.skin}`;
        document.querySelectorAll('.skin-option').forEach(opt => {
            opt.classList.remove('selected');
            if (parseInt(opt.dataset.skin) === this.skin) {
                opt.classList.add('selected');
            }
        });
    }

    startCPU() {
        const name = this.validateName();
        if (!name) return;
        
        window.location.href = `/game?mode=cpu&name=${encodeURIComponent(name)}&skin=${this.skin}`;
    }

    createRoom() {
        const name = this.validateName();
        if (!name) return;
        
        const roomId = Math.floor(1000 + Math.random() * 9000);
        this.showNotification(`Room ${roomId} created!`, 'success');
        
        setTimeout(() => {
            window.location.href = `/game?mode=multi&name=${encodeURIComponent(name)}&skin=${this.skin}&room=${roomId}`;
        }, 1000);
    }

    joinRoom() {
        const name = this.validateName();
        const roomId = document.getElementById('roomCode').value.trim();
        
        if (!name) return;
        if (!roomId || !/^\d{4}$/.test(roomId)) {
            this.showNotification('Enter a valid 4-digit room code', 'error');
            return;
        }
        
        window.location.href = `/game?mode=multi&name=${encodeURIComponent(name)}&skin=${this.skin}&room=${roomId}`;
    }

    validateName() {
        const name = document.getElementById('name').value.trim();
        if (!name) {
            this.showNotification('Please enter your name', 'error');
            document.getElementById('name').focus();
            return null;
        }
        return name;
    }

    showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <span>${message}</span>
            <button onclick="this.parentElement.remove()">Ã—</button>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }
}

document.addEventListener('DOMContentLoaded', () => new Lobby());